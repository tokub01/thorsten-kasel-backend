version: 1.0

deploy:
  # Alle sensiblen Daten werden hier nur Ã¼ber Platzhalter referenziert
  env-vars:
    # App Settings
    APP_NAME: "Laravel"
    APP_ENV: production
    APP_KEY: ${{ secrets.LARAVEL_APP_KEY }}
    APP_DEBUG: false
    APP_URL: ${{ secrets.APP_URL }}
    APP_LOCALE: de

    # Database (IONOS Auto-Generated Secrets aus deinem Screenshot)
    DB_CONNECTION: mysql
    DB_HOST: ${{ secrets.IONOS_DEPLOYMENT_911A3DDB_F0C6_4DCD_ACC2_8F57FCD541FB_DB_HOST }}
    DB_PORT: 3306
    DB_DATABASE: ${{ secrets.IONOS_DEPLOYMENT_911A3DDB_F0C6_4DCD_ACC2_8F57FCD541FB_DB_NAME }}
    DB_USERNAME: ${{ secrets.IONOS_DEPLOYMENT_911A3DDB_F0C6_4DCD_ACC2_8F57FCD541FB_DB_USERNAME }}
    DB_PASSWORD: ${{ secrets.IONOS_DEPLOYMENT_911A3DDB_F0C6_4DCD_ACC2_8F57FCD541FB_DB_PASSWORD }}

    # Mail (IONOS Auto-Generated Secrets)
    MAIL_MAILER: smtp
    MAIL_HOST: ${{ secrets.IONOS_MAIL_HOST }}
    MAIL_PORT: ${{ secrets.IONOS_MAIL_PORT }}
    MAIL_USERNAME: ${{ secrets.IONOS_MAIL_USERNAME }}
    MAIL_PASSWORD: ${{ secrets.IONOS_MAIL_PASSWORD }}
    MAIL_ENCRYPTION: ${{ secrets.IONOS_MAIL_ENCRYPTION }}
    MAIL_FROM_ADDRESS: ${{ secrets.IONOS_MAIL_FROM_ADDRESS }}
    MAIL_FROM_NAME: "Tobias Kubina"

    # AWS S3 Storage
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    AWS_DEFAULT_REGION: eu-central-1
    AWS_BUCKET: kasel-images
    AWS_USE_PATH_STYLE_ENDPOINT: false

    # Services & Security
    RECAPTCHA_SITE_KEY: ${{ secrets.RECAPTCHA_SITE_KEY }}
    RECAPTCHA_SECRET_KEY: ${{ secrets.RECAPTCHA_SECRET_KEY }}
    ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
    FRONTEND_KEY: ${{ secrets.FRONTEND_KEY }}

    # Infrastructure Drivers
    SESSION_DRIVER: database
    CACHE_STORE: database
    QUEUE_CONNECTION: database
    LOG_CHANNEL: stack

  bootstrap:
    excludes:
      - .env
      - tests
      - node_modules
      - DOCKER_ENV
      - docker_tag
      - output.log
    post-deployment-remote-commands:
      - find $(pwd) -type f -not -path "$(pwd)/logs/*" -exec chmod 664 {} \;
      - find $(pwd) -type d -not -name "logs" -exec chmod 775 {} \;
      - chmod -R o+w storage bootstrap/cache
      - php artisan migrate --force
      - php artisan storage:link
      - php artisan optimize

  recurring:
    excludes:
      - .env
      - tests
      - node_modules
      - DOCKER_ENV
      - docker_tag
      - output.log
      - storage
    pre-deployment-remote-commands:
      - php artisan down
    post-deployment-remote-commands:
      - find $(pwd) -type f -not -path "$(pwd)/logs/*" -exec chmod 664 {} \;
      - find $(pwd) -type d -not -name "logs" -exec chmod 775 {} \;
      - chmod -R o+w storage bootstrap/cache
      - php artisan migrate --force
      - php artisan storage:link
      - php artisan optimize
      - php artisan up
